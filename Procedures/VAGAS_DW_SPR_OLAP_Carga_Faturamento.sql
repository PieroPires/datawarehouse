-- SELECT * FROM VAGAS_DW.FATURAMENTO
-- EXEC VAGAS_DW.SPR_OLAP_Carga_Faturamento

IF EXISTS ( SELECT * FROM SYS.OBJECTS WHERE NAME = 'SPR_OLAP_Carga_Faturamento' AND SCHEMA_NAME(SCHEMA_ID) = 'VAGAS_DW')
DROP PROCEDURE VAGAS_DW.SPR_OLAP_Carga_Faturamento
GO

-- =============================================
-- Author: Luiz Fernando Braz
-- Create date: 20/04/2016
-- Description: Procedure para alimentação do DW
-- =============================================
CREATE PROCEDURE VAGAS_DW.SPR_OLAP_Carga_Faturamento

AS
SET NOCOUNT ON

DELETE VAGAS_DW.FATURAMENTO
FROM VAGAS_DW.FATURAMENTO A
WHERE EXISTS ( SELECT * FROM VAGAS_DW.TMP_FATURAMENTO
				WHERE MONTH(DATA_REFERENCIA) = MONTH(A.DATA_REFERENCIA)
				AND YEAR(DATA_REFERENCIA) = YEAR(A.DATA_REFERENCIA) )

-- ATUALIZAR AGRUPAMENTOS DE PRODUTO
UPDATE VAGAS_DW.TMP_FATURAMENTO SET GRUPO_I = B.GRUPO_I,
									GRUPO_II = B.GRUPO_II
FROM VAGAS_DW.TMP_FATURAMENTO A
INNER JOIN VAGAS_DW.GRUPO_PRODUTOS_ERP B ON B.PRODUTO = A.PRODUTO

-- CARREGAR CUBO
INSERT INTO VAGAS_DW.FATURAMENTO (NUM_PEDIDO,COD_CLI_CRM,COD_CLI,CLIENTE,PRODUTO,DATA_EMISSAO,DATA_REFERENCIA,VALOR,
DATA_INICIO_VIGENCIA,DATA_FIM_VIGENCIA,GRUPO_I,GRUPO_II,FLAG_IMPORTACAO)
SELECT * FROM VAGAS_DW.TMP_FATURAMENTO

-- expurgar datas de referencia antigas (deixar apenas a últ. de cada mes)
DELETE VAGAS_DW.FATURAMENTO 
FROM VAGAS_DW.FATURAMENTO A
WHERE DATA_REFERENCIA <> ( SELECT MAX(DATA_REFERENCIA)
						  FROM VAGAS_DW.FATURAMENTO
						  WHERE YEAR(DATA_REFERENCIA) = YEAR(A.DATA_REFERENCIA)
						  AND MONTH(DATA_REFERENCIA) = MONTH(A.DATA_REFERENCIA) )
AND ISNULL(FLAG_IMPORTACAO,0) = 0 -- Apenas registros que não tenha sido importados do sistema anterior ao ERP

DECLARE @ULT_DATA_REFERENCIA SMALLDATETIME

SELECT @ULT_DATA_REFERENCIA = MAX(DATA_REFERENCIA)
FROM VAGAS_DW.FATURAMENTO 
WHERE ISNULL(FLAG_IMPORTACAO,0) = 0 

-- MARCAR EXIBIÇÃO PADRÃO
UPDATE VAGAS_DW.FATURAMENTO SET FLAG_EXIBICAO_PADRAO = 1
FROM VAGAS_DW.FATURAMENTO 
WHERE DATA_REFERENCIA <= @ULT_DATA_REFERENCIA

-- DESMARCAR DATAS QUE FORAM IMPORTADAS PARA DATA FUTURAS (pedidos anteriores à entrada do ERP)
UPDATE VAGAS_DW.FATURAMENTO SET FLAG_EXIBICAO_PADRAO = 0
FROM VAGAS_DW.FATURAMENTO 
WHERE DATA_REFERENCIA > @ULT_DATA_REFERENCIA
AND ISNULL(FLAG_IMPORTACAO,0) = 1

-- AJUSTES DO FINANCEIRO (PRODUTO FOI LANÇADO ERRADO NO ERP)
-- 20160701
UPDATE VAGAS_DW.FATURAMENTO SET PRODUTO = 'COMPL PORTAL',GRUPO_I = 'COMPLEMENTAR',GRUPO_II = 'PORTAL'
FROM VAGAS_DW.FATURAMENTO WHERE NUM_PEDIDO = '007810'

-- 20160701
UPDATE VAGAS_DW.FATURAMENTO SET PRODUTO = 'PUBL ADNETWORK',GRUPO_II = 'ADNETWORK'
FROM VAGAS_DW.FATURAMENTO WHERE NUM_PEDIDO = '009749'

-- AJUSTES DO FINANCEIRO (ITAÚ FOI LANÇADO COM DATA INICIO E FIM DE FORMA ERRADA)
DELETE FROM VAGAS_DW.FATURAMENTO WHERE NUM_PEDIDO = '014572'

INSERT INTO VAGAS_DW.FATURAMENTO VALUES ('014572','4706c89c-e60e-11e4-a9bf-0ea319e5a468','001931','ITAU UNIBANCO S.A.','VAGAS FIT LIC','2016-08-12 00:00:00','2016-01-01 00:00:00',52778.25,
										 NULL,NULL,'VAGAS','FIT',0,1)

INSERT INTO VAGAS_DW.FATURAMENTO VALUES ('014572','4706c89c-e60e-11e4-a9bf-0ea319e5a468','001931','ITAU UNIBANCO S.A.','VAGAS FIT LIC','2016-08-12 00:00:00','2016-02-01 00:00:00',52778.25,
										 NULL,NULL,'VAGAS','FIT',0,1)

INSERT INTO VAGAS_DW.FATURAMENTO VALUES ('014572','4706c89c-e60e-11e4-a9bf-0ea319e5a468','001931','ITAU UNIBANCO S.A.','VAGAS FIT LIC','2016-08-12 00:00:00','2016-03-01 00:00:00',52778.25,
										 NULL,NULL,'VAGAS','FIT',0,1)

INSERT INTO VAGAS_DW.FATURAMENTO VALUES ('014572','4706c89c-e60e-11e4-a9bf-0ea319e5a468','001931','ITAU UNIBANCO S.A.','VAGAS FIT LIC','2016-08-12 00:00:00','2016-04-01 00:00:00',52778.25,
										 NULL,NULL,'VAGAS','FIT',0,1)

INSERT INTO VAGAS_DW.FATURAMENTO VALUES ('014572','4706c89c-e60e-11e4-a9bf-0ea319e5a468','001931','ITAU UNIBANCO S.A.','VAGAS FIT LIC','2016-08-12 00:00:00','2016-05-01 00:00:00',52778.25,
										 NULL,NULL,'VAGAS','FIT',0,1)

INSERT INTO VAGAS_DW.FATURAMENTO VALUES ('014572','4706c89c-e60e-11e4-a9bf-0ea319e5a468','001931','ITAU UNIBANCO S.A.','VAGAS FIT LIC','2016-08-12 00:00:00','2016-06-01 00:00:00',52778.25,
										 NULL,NULL,'VAGAS','FIT',0,1)

INSERT INTO VAGAS_DW.FATURAMENTO VALUES ('014572','4706c89c-e60e-11e4-a9bf-0ea319e5a468','001931','ITAU UNIBANCO S.A.','VAGAS FIT LIC','2016-08-12 00:00:00','2016-07-01 00:00:00',52778.25,
										 NULL,NULL,'VAGAS','FIT',0,1)

INSERT INTO VAGAS_DW.FATURAMENTO VALUES ('014572','4706c89c-e60e-11e4-a9bf-0ea319e5a468','001931','ITAU UNIBANCO S.A.','VAGAS FIT LIC','2016-08-12 00:00:00','2016-08-01 00:00:00',52778.25,
										 NULL,NULL,'VAGAS','FIT',0,1)
