-- =============================================
-- Author: Fiama
-- Create date: 13/03/2018
-- Description: Procedure para alimentação do DW
-- =============================================

USE [VAGAS_DW] ;
GO

IF EXISTS (SELECT * FROM SYS.OBJECTS WHERE NAME = 'SPR_OLAP_Carga_CVs_VAGASFLIX' AND SCHEMA_NAME(SCHEMA_ID) = 'VAGAS_DW')
DROP PROCEDURE [VAGAS_DW].[SPR_OLAP_Carga_CVs_VAGASFLIX] ;
GO

CREATE PROCEDURE [VAGAS_DW].[SPR_OLAP_Carga_CVs_VAGASFLIX]

AS
SET NOCOUNT ON

-- Carga inicial: Dados retroativos (inseridos anteriormente pela Cris Degani - Valores acumulados)
--INSERT INTO [VAGAS_DW].[CVS_VAGASFLIX] (DATA_CARGA, QTD_CADASTROS_VAGASFLIX, CRESCIMENTO)
--VALUES 
-- ('20171127', 34, NULL)
--,('20171129', 260,	6.647058824)	
--,('20171204', 478,	0.838461538)	
--,('20171220', 1064,	1.225941423)	
--,('20171226', 3141,	1.952067669)	
--,('20180108', 8509,	1.709009869)
--,('20180109', 9243,	0.086261605)
--,('20180111', 13905, 0.504381694)
--,('20180123', 19681, 0.415390147)
--,('20180129', 19878, 0.010009654)
--,('20180312', 20294, 0.020927659) ;

DECLARE @ULTIMA_DATA_CARGA SMALLDATETIME ;
SET	@ULTIMA_DATA_CARGA = (SELECT CONVERT(DATE, MAX(DATA_CARGA)) AS ULTIMA_DATA_CARGA FROM VAGAS_DW.CVS_VAGASFLIX AS A)


INSERT INTO [VAGAS_DW].[CVS_VAGASFLIX] (DATA_CARGA, QTD_CADASTROS_VAGASFLIX)
SELECT	A.DATA_CARGA ,
		A.QTD_CADASTROS_VAGASFLIX
FROM	[VAGAS_DW].[TMP_CVS_VAGASFLIX] AS A 
WHERE	A.DATA_CARGA > @ULTIMA_DATA_CARGA ;


-- CRESCIMENTO:
UPDATE	[VAGAS_DW].[CVS_VAGASFLIX]
SET		CRESCIMENTO = (
						SELECT	(CONVERT(FLOAT, A) - CONVERT(FLOAT, B)) / CONVERT(FLOAT, B) AS TAXA_CONVERSAO
						FROM	(
									SELECT	A.DATA_CARGA ,
											A.QTD_CADASTROS_VAGASFLIX AS A ,
											LAG(A.QTD_CADASTROS_VAGASFLIX, 1, 0) OVER(ORDER BY A.DATA_CARGA ASC) AS B ,
											LAG(A.DATA_CARGA, 1, 0) OVER(ORDER BY A.DATA_CARGA ASC) AS DATA_CARGA_ANTERIOR
									FROM	[VAGAS_DW].[CVS_VAGASFLIX] AS A ) AS SUBQUERY
						WHERE	SUBQUERY.DATA_CARGA_ANTERIOR > '19000101'
								AND A.DATA_CARGA = SUBQUERY.DATA_CARGA )
FROM	[VAGAS_DW].[CVS_VAGASFLIX] AS A ;